<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0077b6; }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #0077b6; color: #fff; }
        tr:nth-child(even) { background: #f2f2f2; }
        .actions button { margin: 0 2px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { background: #0077b6; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #023e8a; }
        @media (max-width: 600px) {
            .container { padding: 10px; max-width: 100vw; }
            h1 { font-size: 1.1em; }
            .form-group { margin-bottom: 8px; }
            table { font-size: 0.92em; min-width: 480px; }
            th, td { padding: 4px; }
            .btn { padding: 7px 10px; font-size: 0.95em; }
        }
    </style>
</head>
<body style="display:none;" id="body-block">
    <div class="container">
        <div id="admin-header" style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px;">
            <button class="btn" onclick="goToLogin()">Ir al login</button>
            <button class="btn" id="poderTotalBtn" style="background:#000; color:#e74c3c; font-weight:bold; border:2px solid #e74c3c; margin-left:10px; display:none;">Poder Total</button>
        </div>
        <script>
        // Mostrar botón de poder total solo para el admin principal
        document.addEventListener('DOMContentLoaded', function() {
          if (localStorage.getItem('poderTotal') === '1') {
            document.getElementById('poderTotalBtn').style.display = '';
          } else {
            document.getElementById('poderTotalBtn').style.display = 'none';
          }
        });
        </script>
        <h1>Panel de Control - Administrador</h1>
        <form id="userForm">
            <div class="form-group">
                <label for="nombreCompleto">Nombre Completo</label>
                <input type="text" id="nombreCompleto" required pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$" title="Nombre completo (solo letras y espacios)">
            </div>
            <!-- Eliminado campo username -->
            <div class="form-group">
                <label for="documento">Documento <span style="font-weight:normal; color:#888;">(10 dígitos)</span></label>
                <input type="text" id="documento" required maxlength="10" minlength="10" pattern="[0-9]{10}" title="Debe ser exactamente 10 dígitos" inputmode="numeric" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="pin">PIN <span style="font-weight:normal; color:#888;">(elige un PIN de 4 dígitos)</span></label>
                <input type="text" id="pin" required maxlength="4" minlength="4" pattern="[0-9]{4}" title="Debe ser exactamente 4 dígitos" inputmode="numeric" autocomplete="one-time-code">
            </div>
            <div class="form-group">
                <label for="telefono">Teléfono <span style="font-weight:normal; color:#888;">(10 números)</span></label>
                <input type="text" id="telefono" required maxlength="10" minlength="10" pattern="[0-9]{10}" title="Debe ser exactamente 10 números" inputmode="tel" autocomplete="tel">
            </div>
            <button type="submit" class="btn">Agregar Usuario</button>
        </form>
        <h2>Lista de Usuarios</h2>
        <div style="margin-bottom:12px;">
          <input type="text" id="busquedaUsuarios" placeholder="Buscar por nombre o PIN..." style="width:100%;max-width:320px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;">
        </div>
        <div class="table-responsive">
        <table id="usersTable">
            <thead>
                <tr>
                    <th></th>
                    <th>Nombre Completo</th>
                    <th>PIN</th>
                    <th>Doc.</th>
                    <th>Tel.</th>
                    <th>Número</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Usuarios serán listados aquí -->
            </tbody>
        </table>
        </div>
        <div id="notification" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;min-width:220px;padding:14px 24px;border-radius:6px;font-weight:bold;font-size:1.1em;text-align:center;"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Inicializa Supabase UNA SOLA VEZ y global
      const SUPABASE_URL = 'https://senqhfrzhsvrwiqschuf.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlbnFoZnJ6aHN2cndpcXNjaHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTA3MzksImV4cCI6MjA2NTY4NjczOX0.SoQUuDrUtIObkHMTn6HOOR74MvYTI5bgy4-PDU4p-dg';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Redirigir a login si no está autenticado o no es admin
      (async function() {
        // Refuerzo de seguridad: comprobar expiración de sesión por última actividad
        const lastActivityLS = localStorage.getItem('lastActivity');
        if (lastActivityLS && Date.now() - parseInt(lastActivityLS, 10) > 15 * 60 * 1000) {
          localStorage.removeItem('bahiaChillLogin');
          localStorage.removeItem('currentUser');
          localStorage.removeItem('lastActivity');
          window.location.replace('index.html');
          return;
        }
        if (localStorage.getItem('bahiaChillLogin') !== 'ok' || !localStorage.getItem('currentUser')) {
          window.location.replace('index.html');
          return;
        }
        const currentUser = localStorage.getItem('currentUser');
        // Buscar admin por documento, no por username
        const { data, error } = await supabase.from('usuarios').select('admin').eq('documento', currentUser);
        if (error || !data || data.length === 0 || data[0].admin !== true) {
          window.location.replace('index.html');
          return;
        }
        document.getElementById('body-block').style.display = '';
      })();

      // Usuarios por defecto
      // Eliminado defaultUsers con username

      // CRUD Supabase
      async function getAllUsersSupabase() {
        const { data, error } = await supabase.from('usuarios').select('*');
        return data || [];
      }
      async function getUserSupabasePorDocumento(documento) {
        const { data, error } = await supabase.from('usuarios').select('*').eq('documento', documento).maybeSingle();
        if (error) return null;
        return data;
      }
      async function createUserSupabase(user) {
        // Elimina el campo username si existe en el objeto user
        if ('username' in user) delete user.username;
        // Asigna número (stickers) por defecto a 2 si no está definido
        if (typeof user.numero === 'undefined' || user.numero === null) user.numero = 2;
        const { data, error } = await supabase.from('usuarios').insert([user]);
        return { data, error };
      }
      async function updateUserSupabasePorDocumento(documento, fields) {
        const { data, error } = await supabase.from('usuarios').update(fields).eq('documento', documento);
        return { data, error };
      }
      async function deleteUserSupabasePorDocumento(documento) {
        const { data, error } = await supabase.from('usuarios').delete().eq('documento', documento);
        return { data, error };
      }

      // Renderizado de usuarios
      async function renderUsers() {
        const users = await getAllUsersSupabase();
        const filtro = (document.getElementById('busquedaUsuarios')?.value || '').toLowerCase();
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        // Ocultar Admin si el usuario actual es Bc
        const currentUser = localStorage.getItem('currentUser');
        users.filter(user => {
          // Si el usuario actual es admin, no ocultar nada
          if (!filtro) return true;
          return (
            (user.nombreCompleto && user.nombreCompleto.toLowerCase().includes(filtro)) ||
            (user.pin && user.pin.toLowerCase().includes(filtro))
          );
        }).forEach((user, idx) => {
          const isPaused = user.paused;
          const icon = isPaused ? '▶️' : '⏸️';
          const iconTitle = isPaused ? 'Reactivar usuario' : 'Pausar usuario';
          const numero = typeof user.numero === 'number' && user.numero >= 0 && user.numero <= 10 ? user.numero : 0;
          let selectOptions = '';
          for (let i = 0; i <= 10; i++) {
            selectOptions += `<option value="${i}"${i === numero ? ' selected' : ''}>${i}</option>`;
          }
          let nombreCompleto = user.nombreCompleto || '';
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="width:40px;">
              <button onclick="togglePauseUserPorDocumento('${user.documento}')" title="${iconTitle}" style="background:none;border:none;font-size:1.2em;cursor:pointer;">${icon}</button>
            </td>
            <td><input type="text" value="${nombreCompleto}" data-documento="${user.documento}" class="edit-nombreCompleto" disabled></td>
            <td><input type="text" value="${user.pin}" data-documento="${user.documento}" class="edit-pin" maxlength="6" disabled inputmode="numeric" autocomplete="one-time-code" pattern="[0-9]{4}"></td>
            <td><input type="text" value="${user.documento || ''}" data-documento="${user.documento}" class="edit-documento" maxlength="10" disabled inputmode="numeric" autocomplete="off" pattern="[0-9]{10}"></td>
            <td><input type="text" value="${user.telefono || ''}" data-documento="${user.documento}" class="edit-telefono" maxlength="10" disabled inputmode="tel" autocomplete="tel" pattern="[0-9]{10}"></td>
            <td><select data-documento="${user.documento}" class="edit-numero" disabled>${selectOptions}</select></td>
            <td class="actions">
              <button onclick="enableEditPorDocumento('${user.documento}')">Modificar</button>
              <button onclick="confirmDeleteUserPorDocumento('${user.documento}')">Eliminar</button>
              <button onclick="saveUserPorDocumento('${user.documento}')" class="save-btn" style="display:none;">Guardar</button>
              <button onclick="cancelEdit()" class="cancel-btn" style="display:none;">Cancelar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Suscripción realtime a cambios en la tabla usuarios (solo una vez, global)
      const channel = supabase.channel('usuarios-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'usuarios' }, (payload) => {
          renderUsers();
        })
        .subscribe();

      // Función para mostrar notificaciones
      function showNotification(msg, type = 'success') {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.display = 'block';
        notif.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
        notif.style.color = type === 'success' ? '#155724' : '#721c24';
        notif.style.border = type === 'success' ? '1.5px solid #28a745' : '1.5px solid #dc3545';
        notif.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
        setTimeout(() => { notif.style.display = 'none'; }, 2500);
      }



      document.getElementById('userForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const nombreCompleto = document.getElementById('nombreCompleto').value.trim();
        const documento = document.getElementById('documento').value.trim();
        const pin = document.getElementById('pin').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        let numero = 0;
        // Validaciones estrictas
        if (!nombreCompleto.match(/^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/)) {
          showNotification('El nombre completo solo puede contener letras y espacios.', 'error');
          return;
        }
        if (!documento.match(/^\d{10}$/)) {
          showNotification('El documento debe ser exactamente 10 dígitos.', 'error');
          return;
        }
        if (!pin.match(/^\d{4}$/)) {
          showNotification('El PIN debe ser exactamente 4 dígitos.', 'error');
          return;
        }
        if (!telefono.match(/^\d{10}$/)) {
          showNotification('El teléfono debe ser exactamente 10 números.', 'error');
          return;
        }

        // Verifica si el teléfono ya fue registrado
        const { data: existingPhone, error: errorPhone } = await supabase.from('usuarios').select('id').eq('telefono', telefono);
        if (errorPhone) {
          showNotification('Error de conexión con Supabase: ' + errorPhone.message, 'error');
          return;
        }
        if (existingPhone && existingPhone.length > 0) {
          showNotification('El Teléfono ya fué registrado, intente con otro diferente', 'error');
          return;
        }

        // El documento debe ser único
        const { data: existingDoc, error: errorDoc } = await supabase.from('usuarios').select('id').eq('documento', documento);
        if (errorDoc) {
          showNotification('Error de conexión con Supabase: ' + errorDoc.message, 'error');
          return;
        }
        if (existingDoc && existingDoc.length > 0) {
          showNotification('Ya existe un usuario con ese documento.', 'error');
          return;
        }

        // Intenta crear el usuario (sin campo username)
        // Supabase requiere: nombreCompleto, username, pin, documento, telefono, numero
        // username será igual al documento (o vacío si lo prefieres)
        const userObj = {
          nombreCompleto,
          username: documento, // o "" si prefieres dejarlo vacío
          pin,
          documento,
          telefono,
          numero: parseInt(numero, 10) || 0
        };
        const { error } = await supabase.from('usuarios').insert([userObj]);
        if (error) {
          showNotification('Error al crear usuario: ' + (error.message || error.details || error), 'error');
          return;
        }
        showNotification('Añadido con éxito', 'success');
        await renderUsers();
        this.reset();
        document.getElementById('pin').value = '';
      });

      // Edición y acciones de usuario
      window.enableEditPorDocumento = function(documento) {
        document.querySelector(`.edit-nombreCompleto[data-documento='${documento}']`).disabled = false;
        document.querySelector(`.edit-documento[data-documento='${documento}']`).disabled = false;
        document.querySelector(`.edit-telefono[data-documento='${documento}']`).disabled = false;
        document.querySelector(`.edit-numero[data-documento='${documento}']`).disabled = false;
        document.querySelector(`.edit-pin[data-documento='${documento}']`).disabled = false;
        const tr = Array.from(document.querySelectorAll('#usersTable tbody tr')).find(tr => tr.querySelector(`.edit-documento[data-documento='${documento}']`));
        tr.querySelector('.save-btn').style.display = '';
        tr.querySelector('.cancel-btn').style.display = '';
        tr.querySelector('button[onclick^="enableEditPorDocumento"]').style.display = 'none';
        tr.querySelector('button[onclick^="confirmDeleteUserPorDocumento"]').style.display = 'none';
      }
      window.saveUserPorDocumento = async function(documento) {
        const nombreCompleto = document.querySelector(`.edit-nombreCompleto[data-documento='${documento}']`).value.trim();
        const pin = document.querySelector(`.edit-pin[data-documento='${documento}']`).value.trim();
        const documentoVal = document.querySelector(`.edit-documento[data-documento='${documento}']`).value.trim();
        const telefono = document.querySelector(`.edit-telefono[data-documento='${documento}']`).value.trim();
        const numero = parseInt(document.querySelector(`.edit-numero[data-documento='${documento}']`).value, 10);
        if (!nombreCompleto.match(/^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$/)) {
          showNotification('El nombre completo solo puede contener letras y espacios.', 'error');
          return;
        }
        if (isNaN(numero) || numero < 0 || numero > 10) return showNotification('El número debe estar entre 0 y 10', 'error');
        if (!documentoVal.match(/^[0-9]{10}$/)) return showNotification('El documento debe ser exactamente 10 dígitos', 'error');
        if (!pin.match(/^\d{4}$/)) {
          showNotification('El PIN debe ser exactamente 4 dígitos.', 'error');
          return;
        }
        const { error } = await updateUserSupabasePorDocumento(documento, { nombreCompleto, pin, documento: documentoVal, telefono, numero });
        if (error) {
          showNotification('Error al modificar usuario: ' + error.message, 'error');
        } else {
          showNotification('Modificado con éxito', 'success');
        }
        renderUsers();
      }
      // Función obsoleta, ya no se usa saveUser por username, solo por documento
      window.saveUser = function() { showNotification('Función obsoleta. Usa saveUserPorDocumento.', 'error'); };
      window.cancelEdit = function() {
        renderUsers();
      }
      // Variable global para el modo Borrado Especial
      let borradoEspecialActivado = false;
window.confirmDeleteUserPorDocumento = async function(documento) {
  // Buscar datos completos del usuario a eliminar (por documento)
  const users = await getAllUsersSupabase();
  let userToDelete = users.find(u => u.documento === documento);
  if (!userToDelete) {
    alert('No se encontró el usuario a eliminar.');
    return;
  }
  // Impedir eliminación de admins especiales (documento y teléfono 0000000000)
  if (userToDelete.documento === '0000000000' && userToDelete.telefono === '0000000000') {
    alert('No puedes eliminar este usuario especial.');
    return;
  }
  if (!borradoEspecialActivado && ['1234561234', '2467892467', '2272222272', '1019602272'].includes(documento)) {
    alert('No puedes eliminar un usuario por defecto.');
    return;
  }
  if ((userToDelete.documento === '2272222272' || userToDelete.documento === '1019602272') && !borradoEspecialActivado) {
    alert('No puedes eliminar el usuario Admin.');
    return;
  }
  // Impedir eliminación de cualquier usuario con admin === true
  if (userToDelete.admin === true) {
    alert('No puedes eliminar un usuario con rol de admin.');
    return;
  }
  let nombreCompleto = userToDelete.nombreCompleto || '';
  if (confirm(`¿Estás seguro de eliminar a ${nombreCompleto} con cédula ${documento}?`)) {
    await window.deleteUserByDocumento(documento);
  }
}
window.deleteUserByDocumento = async function(documento) {
  const { error } = await deleteUserSupabasePorDocumento(documento);
  if (error) {
    showNotification('Error al eliminar usuario: ' + error.message, 'error');
  } else {
    showNotification('Eliminado con éxito', 'success');
  }
  renderUsers();
}
      window.togglePauseUserPorDocumento = async function(documento) {
        if (["1234561234", "2467892467", "2272222272", "1019602272"].includes(documento)) {
          showNotification('No puedes pausar un usuario por defecto.', 'error');
          return;
        }
        const user = await getUserSupabasePorDocumento(documento);
        const { error } = await updateUserSupabasePorDocumento(documento, { paused: !user.paused });
        if (error) {
          showNotification('Error al cambiar estado: ' + error.message, 'error');
        } else {
          showNotification(!user.paused ? 'Pausado con éxito' : 'Despausado con éxito', 'success');
        }
        renderUsers();
      }

      // Poder Total (solo para Admin)
      let poderTotalAutorizado = false;
      document.addEventListener('DOMContentLoaded', async function() {
        await renderUsers();
        // Mostrar botón de Poder Total SOLO si el usuario es 'Admin' y es admin
        const poderTotalBtn = document.getElementById('poderTotalBtn');
        const currentUser = localStorage.getItem('currentUser');
        let isAdmin = false;
        // Admin principal: 1019602272
        if (currentUser === '1019602272') {
          try {
            const { data, error } = await supabase.from('usuarios').select('admin').eq('documento', currentUser);
            if (error) {
              alert('Error de conexión con Supabase: ' + error.message);
            } else if (data && data.length > 0 && data[0].admin === true) {
              isAdmin = true;
            }
          } catch (e) {
            alert('Error de conexión con Supabase: ' + e.message);
          }
        }
        poderTotalBtn.style.display = isAdmin ? '' : 'none';
        // Mostrar panel solo si Admin pulsa el botón y pasa la clave
        poderTotalBtn.onclick = async function() {
          if (!poderTotalAutorizado) {
            const clave = prompt('Digite la clave para acceder al poder total:');
            if (clave !== 'Pepitapigi1.') {
              alert('Clave incorrecta.');
              return;
            }
            poderTotalAutorizado = true;
          }
          mostrarPanelPoderTotal();
        };
      });
      async function mostrarPanelPoderTotal() {
        let panel = document.getElementById('poderTotalPanel');
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'poderTotalPanel';
          panel.style = 'background:#fff; color:#222; border:2px solid #e67e22; border-radius:8px; padding:18px; margin-bottom:18px; max-width:400px;';
          document.querySelector('.container').insertBefore(panel, document.querySelector('h1'));
        }
        // Buscar todos los usuarios con rol admin excepto el admin principal
        const { data: adminUsers, error: errorAdmins } = await supabase.from('usuarios').select('*').eq('admin', true).neq('documento', '1019602272');
        let adminHtml = '';
        if (adminUsers && adminUsers.length > 0) {
          adminUsers.forEach((user, idx) => {
            const isPaused = user.paused;
            const icon = isPaused ? '▶️' : '⏸️';
            const iconTitle = isPaused ? 'Reactivar admin' : 'Pausar admin';
            adminHtml += `
              <div style='display:flex; align-items:center; gap:12px; margin-bottom:8px;'>
                <b>Doc:</b> <span style='color:#888;'>${user.documento || ''}</span>
                <b>PIN:</b> <span style='color:#e67e22;'>${user.pin}</span>
                <button onclick="(async()=>{await window.togglePauseUserPorDocumento('${user.documento}')})()" title="${iconTitle}" style="background:none;border:none;font-size:1.2em;cursor:pointer;">${icon}</button>
              </div>
            `;
          });
        } else {
          adminHtml = '<div style="color:#888;">No hay admins secundarios registrados.</div>';
        }
        panel.innerHTML = `
          <div style='font-weight:bold; color:#0077b6; margin-bottom:10px;'>Administradores secundarios</div>
          ${adminHtml}
          <button id="pausarTodosBtn" style="margin-top:10px; background:#e74c3c; color:#fff; border:none; border-radius:6px; padding:10px 18px; font-weight:bold; cursor:pointer;">Pausar a todos los admins secundarios</button>
          <button id="despausarTodosBtn" style="margin-top:10px; background:#27ae60; color:#fff; border:none; border-radius:6px; padding:10px 18px; font-weight:bold; cursor:pointer; margin-left:10px;">Despausar a todos los admins secundarios</button>
          <div style='margin-top:18px; padding:10px; border-top:1px solid #eee; display:flex; align-items:center; gap:12px;'>
            <div style='background:#f4f4f4; border-radius:6px; padding:7px 14px; font-weight:bold; border:1.5px solid #e67e22;'>Borrado Especial</div>
            <button id="borradoEspecialSwitch" style="background:none; border:none; font-size:1.1em; cursor:pointer; font-weight:bold; color:${borradoEspecialActivado ? '#27ae60' : '#c0392b'};">${borradoEspecialActivado ? '✅ Activado' : '❌ Desactivado'}</button>
          </div>
          <div id="borradoEspecialMsg" style="margin-top:6px; color:#c0392b; font-size:0.98em;"></div>
          <hr style='margin:22px 0 16px 0;border:0;border-top:1.5px solid #e67e22;'>
          <div id="faqEditPanel" style="margin-bottom:10px;">
            <button id="faqEditToggle" style="width:100%;background:#e67e22;color:#fff;font-weight:bold;padding:10px 0;border:none;border-radius:6px;font-size:1.1em;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;">
              <span>Editar FAQ</span> <span id="faqEditArrow" style="transition:transform 0.3s;font-size:1.2em;">&#9660;</span>
            </button>
            <div id="faqEditContent" style="display:none;animation:fadeIn 0.3s;">
              <form id="faqForm">
                ${[1,2,3,4,5].map(i => `
                  <div style='margin-bottom:12px;'>
                    <label style='font-weight:bold;color:#0077b6;'>Pregunta ${i}</label>
                    <input type='text' name='pregunta${i}' id='pregunta${i}' style='width:100%;padding:7px 10px;border-radius:5px;border:1px solid #ccc;margin-bottom:5px;'>
                    <textarea name='respuesta${i}' id='respuesta${i}' rows='2' style='width:100%;padding:7px 10px;border-radius:5px;border:1px solid #ccc;resize:vertical;'></textarea>
                  </div>
                `).join('')}
                <button type="submit" class="btn" style="background:#e67e22;">Guardar FAQ</button>
              </form>
              <div id="faqSaveMsg" style="margin-top:10px;font-weight:bold;"></div>
            </div>
          </div>
        `;
        document.getElementById('pausarTodosBtn').onclick = pausarTodosAdminsSecundarios;
        document.getElementById('despausarTodosBtn').onclick = despausarTodosAdminsSecundarios;
        document.getElementById('borradoEspecialSwitch').onclick = function() {
          borradoEspecialActivado = !borradoEspecialActivado;
          mostrarPanelPoderTotal();
        };
        // FAQ: menú desplegable
        const faqEditToggle = document.getElementById('faqEditToggle');
        const faqEditContent = document.getElementById('faqEditContent');
        const faqEditArrow = document.getElementById('faqEditArrow');
        if (faqEditToggle && faqEditContent && faqEditArrow) {
          faqEditToggle.onclick = function() {
            const open = faqEditContent.style.display === 'block';
            faqEditContent.style.display = open ? 'none' : 'block';
            faqEditArrow.style.transform = open ? 'rotate(0deg)' : 'rotate(180deg)';
          };
        }
        // FAQ: Cargar y guardar desde Supabase
        const faqForm = document.getElementById('faqForm');
        const faqSaveMsg = document.getElementById('faqSaveMsg');
        if (faqForm) {
          // Cargar FAQ al abrir el panel
          (async function cargarFAQ() {
            const { data, error } = await supabase.from('faq').select('*').order('orden', { ascending: true });
            if (!error && data && data.length > 0) {
              for (let i = 1; i <= 5; i++) {
                document.getElementById('pregunta'+i).value = data[i-1]?.pregunta || '';
                document.getElementById('respuesta'+i).value = data[i-1]?.respuesta || '';
              }
            }
            // ACTUALIZAR FAQ EN MODAL DE TARJETA SI EXISTE
            if (window.parent && window.parent !== window && window.parent.document) {
              // Si está en iframe, no hacer nada
              return;
            }
            try {
              const tarjetaFaqModal = window.opener ? window.opener.document.getElementById('faq-modal-integrado') : document.getElementById('faq-modal-integrado');
              if (tarjetaFaqModal) {
                const blocks = tarjetaFaqModal.querySelectorAll('.faq-block');
                for (let i = 0; i < blocks.length && i < data.length; i++) {
                  blocks[i].querySelector('.faq-block-header').innerHTML = data[i].pregunta + ' <span class="triangle">&#9660;</span>';
                  blocks[i].querySelector('.faq-block-content').textContent = data[i].respuesta;
                }
              }
            } catch(e) {}
          })();
          // Guardar FAQ en Supabase
          faqForm.onsubmit = async function(e) {
            e.preventDefault();
            let ok = true;
            for (let i = 1; i <= 5; i++) {
              const pregunta = document.getElementById('pregunta'+i).value.trim();
              const respuesta = document.getElementById('respuesta'+i).value.trim();
              if (!pregunta || !respuesta) ok = false;
            }
            if (!ok) {
              faqSaveMsg.textContent = 'Completa todas las preguntas y respuestas.';
              faqSaveMsg.style.color = '#c0392b';
              setTimeout(()=>{faqSaveMsg.textContent='';}, 2000);
              return;
            }
            // Obtener los registros actuales
            const { data: faqs, error: errorGet } = await supabase.from('faq').select('*').order('orden', { ascending: true });
            let updates = [];
            for (let i = 1; i <= 5; i++) {
              const pregunta = document.getElementById('pregunta'+i).value.trim();
              const respuesta = document.getElementById('respuesta'+i).value.trim();
              if (faqs && faqs[i-1]) {
                // Update existente
                updates.push(supabase.from('faq').update({ pregunta, respuesta, orden: i }).eq('id', faqs[i-1].id));
              } else {
                // Insertar nuevo
                updates.push(supabase.from('faq').insert({ pregunta, respuesta, orden: i }));
              }
            }
            // Ejecutar todas las actualizaciones/inserciones
            try {
              await Promise.all(updates);
              faqSaveMsg.textContent = 'FAQ guardado correctamente en Supabase';
              faqSaveMsg.style.color = '#27ae60';
              // ACTUALIZAR FAQ EN MODAL DE TARJETA SI EXISTE
              try {
                const tarjetaFaqModal = window.opener ? window.opener.document.getElementById('faq-modal-integrado') : document.getElementById('faq-modal-integrado');
                if (tarjetaFaqModal) {
                  const blocks = tarjetaFaqModal.querySelectorAll('.faq-block');
                  for (let i = 0; i < blocks.length && i < 5; i++) {
                    const pregunta = document.getElementById('pregunta'+(i+1)).value.trim();
                    const respuesta = document.getElementById('respuesta'+(i+1)).value.trim();
                    blocks[i].querySelector('.faq-block-header').innerHTML = pregunta + ' <span class="triangle">&#9660;</span>';
                    blocks[i].querySelector('.faq-block-content').textContent = respuesta;
                  }
                }
              } catch(e) {}
            } catch (err) {
              faqSaveMsg.textContent = 'Error al guardar FAQ';
              faqSaveMsg.style.color = '#c0392b';
            }
            setTimeout(()=>{faqSaveMsg.textContent='';}, 2000);
          };
        }
      }
      async function pausarTodosAdminsSecundarios() {
        // Pausa todos los usuarios con admin=true excepto el admin principal
        const { data, error } = await supabase.from('usuarios').select('documento, paused, admin');
        if (error) {
          showNotification('Error al obtener usuarios: ' + error.message, 'error');
          return;
        }
        const usuariosAPausar = data.filter(u => u.admin === true && u.documento !== '1019602272' && !u.paused);
        if (usuariosAPausar.length === 0) {
          showNotification('No hay admins secundarios activos para pausar.', 'success');
          return;
        }
        const documentos = usuariosAPausar.map(u => u.documento);
        const { error: errorUpdate } = await supabase.from('usuarios').update({ paused: true }).in('documento', documentos);
        if (errorUpdate) {
          showNotification('Error al pausar admins secundarios: ' + errorUpdate.message, 'error');
        } else {
          showNotification('Todos los admins secundarios han sido pausados.', 'success');
        }
        renderUsers();
        mostrarPanelPoderTotal();
      }
      async function despausarTodosAdminsSecundarios() {
        if (!confirm('Al aplicar esta función, todos los admins secundarios (incluidos los que estaban bloqueados antes de la pausa masiva) serán despausados, ¿desea continuar?')) return;
        const { data, error } = await supabase.from('usuarios').select('documento, paused, admin');
        if (error) {
          showNotification('Error al obtener usuarios: ' + error.message, 'error');
          return;
        }
        const usuariosADespausar = data.filter(u => u.admin === true && u.documento !== '1019602272' && u.paused);
        if (usuariosADespausar.length === 0) {
          showNotification('No hay admins secundarios pausados para despausar.', 'success');
          return;
        }
        const documentos = usuariosADespausar.map(u => u.documento);
        const { error: errorUpdate } = await supabase.from('usuarios').update({ paused: false }).in('documento', documentos);
        if (errorUpdate) {
          showNotification('Error al despausar admins secundarios: ' + errorUpdate.message, 'error');
        } else {
          showNotification('Todos los admins secundarios han sido despausados.', 'success');
        }
        renderUsers();
        mostrarPanelPoderTotal();
      }
      window.togglePauseBc = async function() {
        const user = await getUserSupabase('Bc');
        const { error } = await updateUserSupabase('Bc', { paused: !user.paused });
        if (error) {
          showNotification('Error al cambiar estado: ' + error.message, 'error');
        } else {
          showNotification(!user.paused ? 'Pausado con éxito' : 'Despausado con éxito', 'success');
        }
        mostrarPanelPoderTotal();
      }
      // BARRA DE BÚSQUEDA DE USUARIOS
      // Evento para filtrar usuarios en tiempo real
      if (document.getElementById('busquedaUsuarios')) {
        document.getElementById('busquedaUsuarios').addEventListener('input', renderUsers);
      }
      function goToLogin() {
        if (confirm('¿Estás seguro de querer ir al login?')) {
          // Cierra sesión limpiando localStorage
          localStorage.removeItem('bahiaChillLogin');
          localStorage.removeItem('currentUser');
          window.location.href = 'index.html';
        }
      }
      // Eliminado autocompletado de PIN: ahora el admin lo digita manualmente
      // Cierre de sesión automático tras 15 minutos de inactividad
      let lastActivity = Date.now();
      function resetInactivityTimer() {
        lastActivity = Date.now();
        localStorage.setItem('lastActivity', lastActivity.toString());
      }
      document.addEventListener('mousemove', resetInactivityTimer);
      document.addEventListener('keydown', resetInactivityTimer);
      document.addEventListener('mousedown', resetInactivityTimer);
      document.addEventListener('touchstart', resetInactivityTimer);
      setInterval(function() {
        if (Date.now() - lastActivity > 15 * 60 * 1000) {
          localStorage.removeItem('bahiaChillLogin');
          localStorage.removeItem('currentUser');
          localStorage.removeItem('lastActivity');
          window.location.href = 'index.html';
        }
      }, 60000);
    </script>
</body>
</html>
