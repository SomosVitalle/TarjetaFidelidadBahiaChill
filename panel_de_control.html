<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0077b6; }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #0077b6; color: #fff; }
        tr:nth-child(even) { background: #f2f2f2; }
        .actions button { margin: 0 2px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .btn { background: #0077b6; color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #023e8a; }
        @media (max-width: 600px) {
            .container { padding: 10px; max-width: 100vw; }
            h1 { font-size: 1.1em; }
            .form-group { margin-bottom: 8px; }
            table { font-size: 0.92em; min-width: 480px; }
            th, td { padding: 4px; }
            .btn { padding: 7px 10px; font-size: 0.95em; }
        }
    </style>
</head>
<body style="display:none;" id="body-block">
    <div class="container">
        <div id="admin-header" style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:20px;">
            <button class="btn" onclick="goToLogin()">Ir al login</button>
            <button class="btn" id="poderTotalBtn" style="background:#000; color:#e74c3c; font-weight:bold; border:2px solid #e74c3c; margin-left:10px; display:none;">Poder Total</button>
        </div>
        <h1>Panel de Control - Administrador</h1>
        <form id="userForm">
            <div class="form-group">
                <label for="username">Usuario <span style="font-weight:normal; color:#888;">(Solo poner el Primer nombre)</span></label>
                <input type="text" id="username" required pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ]+$" title="Solo el primer nombre, sin espacios ni números">
            </div>
            <div class="form-group">
                <label for="documento">Documento <span style="font-weight:normal; color:#888;">(10 dígitos)</span></label>
                <input type="text" id="documento" required maxlength="10" minlength="10" pattern="[0-9]{10}" title="Debe ser exactamente 10 dígitos" inputmode="numeric" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="pin">PIN <span style="font-weight:normal; color:#888;">(últimos 4 dígitos del documento, se autocompleta)</span></label>
                <input type="text" id="pin" required maxlength="4" minlength="4" pattern="[0-9]{4}" title="Debe ser exactamente 4 dígitos" inputmode="numeric" autocomplete="one-time-code" readonly style="background:#f4f4f4;cursor:not-allowed;">
            </div>
            <div class="form-group">
                <label for="telefono">Teléfono <span style="font-weight:normal; color:#888;">(10 números)</span></label>
                <input type="text" id="telefono" required maxlength="10" minlength="10" pattern="[0-9]{10}" title="Debe ser exactamente 10 números" inputmode="tel" autocomplete="tel">
            </div>
            <button type="submit" class="btn">Agregar Usuario</button>
        </form>
        <h2>Lista de Usuarios</h2>
        <div style="margin-bottom:12px;">
          <input type="text" id="busquedaUsuarios" placeholder="Buscar por nombre o PIN..." style="width:100%;max-width:320px;padding:8px 12px;border-radius:6px;border:1px solid #ccc;">
        </div>
        <div class="table-responsive">
        <table id="usersTable">
            <thead>
                <tr>
                    <th></th>
                    <th>Usuario</th>
                    <th>PIN</th>
                    <th>Doc.</th>
                    <th>Tel.</th>
                    <th>Número</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Usuarios serán listados aquí -->
            </tbody>
        </table>
        </div>
        <div id="notification" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:1000;min-width:220px;padding:14px 24px;border-radius:6px;font-weight:bold;font-size:1.1em;text-align:center;"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Inicializa Supabase UNA SOLA VEZ y global
      const SUPABASE_URL = 'https://senqhfrzhsvrwiqschuf.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNlbnFoZnJ6aHN2cndpcXNjaHVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTA3MzksImV4cCI6MjA2NTY4NjczOX0.SoQUuDrUtIObkHMTn6HOOR74MvYTI5bgy4-PDU4p-dg';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Redirigir a login si no está autenticado o no es admin
      (async function() {
        if (localStorage.getItem('bahiaChillLogin') !== 'ok' || !localStorage.getItem('currentUser')) {
          window.location.replace('index.html');
          return;
        }
        const currentUser = localStorage.getItem('currentUser');
        const { data, error } = await supabase.from('usuarios').select('admin').eq('username', currentUser);
        if (error || !data || data.length === 0 || data[0].admin !== true) {
          window.location.replace('index.html');
          return;
        }
        document.getElementById('body-block').style.display = '';
      })();

      // Usuarios por defecto
      const defaultUsers = [
        { username: 'Juan', pin: '1234', documento: '1234561234', telefono: '', numero: 0, paused: false, admin: false },
        { username: 'Bc', pin: '2467', documento: '2467892467', telefono: '', numero: 0, paused: false, admin: true },
        { username: 'Admin', pin: '2272', documento: '2272222272', telefono: '', numero: 0, paused: false, admin: true }
      ];

      // CRUD Supabase
      async function getAllUsersSupabase() {
        const { data, error } = await supabase.from('usuarios').select('*');
        return data || [];
      }
      async function getUserSupabase(username) {
        const { data, error } = await supabase.from('usuarios').select('*').eq('username', username).maybeSingle();
        if (error) return null;
        return data;
      }
      async function createUserSupabase(user) {
        const { data, error } = await supabase.from('usuarios').insert([user]);
        return { data, error };
      }
      async function updateUserSupabase(username, fields) {
        const { data, error } = await supabase.from('usuarios').update(fields).eq('username', username);
        return { data, error };
      }
      async function deleteUserSupabase(username) {
        const { data, error } = await supabase.from('usuarios').delete().eq('username', username);
        return { data, error };
      }

      // Normaliza el nombre de usuario: solo letras, primera mayúscula, resto minúsculas
      function normalizeUsername(str) {
        if (!str) return '';
        // Quitar todo lo que no sea letra
        let clean = str.replace(/[^A-Za-zÁÉÍÓÚáéíóúÑñ]/g, '');
        if (clean.length === 0) return '';
        return clean.charAt(0).toUpperCase() + clean.slice(1).toLowerCase();
      }

      // Renderizado de usuarios
      async function renderUsers() {
        const users = await getAllUsersSupabase();
        const filtro = (document.getElementById('busquedaUsuarios')?.value || '').toLowerCase();
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        // Ocultar Admin si el usuario logueado es Bc
        const currentUser = localStorage.getItem('currentUser');
        users.filter(user => {
          if (!filtro) return true;
          return (
            (user.username && user.username.toLowerCase().includes(filtro)) ||
            (user.pin && user.pin.toLowerCase().includes(filtro))
          );
        }).forEach((user, idx) => {
          if (currentUser === 'Bc' && user.username === 'Admin') return; // Oculta Admin para Bc
          const isPaused = user.paused;
          const icon = isPaused ? '▶️' : '⏸️';
          const iconTitle = isPaused ? 'Reactivar usuario' : 'Pausar usuario';
          const numero = typeof user.numero === 'number' && user.numero >= 0 && user.numero <= 10 ? user.numero : 0;
          let selectOptions = '';
          for (let i = 0; i <= 10; i++) {
            selectOptions += `<option value="${i}"${i === numero ? ' selected' : ''}>${i}</option>`;
          }
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td style="width:40px;">
              <button onclick="togglePauseUserById('${user.id}')" title="${iconTitle}" style="background:none;border:none;font-size:1.2em;cursor:pointer;">${icon}</button>
            </td>
            <td><input type="text" value="${user.username}" data-id="${user.id}" class="edit-username" disabled></td>
            <td><input type="text" value="${user.pin}" data-id="${user.id}" class="edit-pin" maxlength="6" disabled inputmode="numeric" autocomplete="one-time-code" pattern="[0-9]{4}"></td>
            <td><input type="text" value="${user.documento || ''}" data-id="${user.id}" class="edit-documento" maxlength="10" disabled inputmode="numeric" autocomplete="off" pattern="[0-9]{10}"></td>
            <td><input type="text" value="${user.telefono || ''}" data-id="${user.id}" class="edit-telefono" maxlength="10" disabled inputmode="tel" autocomplete="tel" pattern="[0-9]{10}"></td>
            <td><select data-id="${user.id}" class="edit-numero" disabled>${selectOptions}</select></td>
            <td class="actions">
              <button onclick="enableEdit('${user.id}')">Modificar</button>
              <button onclick="confirmDeleteUserById('${user.id}')">Eliminar</button>
              <button onclick="saveUser('${user.id}')" class="save-btn" style="display:none;">Guardar</button>
              <button onclick="cancelEdit()" class="cancel-btn" style="display:none;">Cancelar</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Suscripción realtime a cambios en la tabla usuarios (solo una vez, global)
      const channel = supabase.channel('usuarios-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'usuarios' }, (payload) => {
          renderUsers();
        })
        .subscribe();

      // Función para mostrar notificaciones
      function showNotification(msg, type = 'success') {
        const notif = document.getElementById('notification');
        notif.textContent = msg;
        notif.style.display = 'block';
        notif.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
        notif.style.color = type === 'success' ? '#155724' : '#721c24';
        notif.style.border = type === 'success' ? '1.5px solid #28a745' : '1.5px solid #dc3545';
        notif.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
        setTimeout(() => { notif.style.display = 'none'; }, 2500);
      }

      // Formulario de creación de usuario
      document.getElementById('userForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        let username = document.getElementById('username').value.trim();
        username = normalizeUsername(username);
        document.getElementById('username').value = username;
        const documento = document.getElementById('documento').value.trim();
        const pin = document.getElementById('pin').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const numero = 0;
        // Validaciones estrictas
        if (!username.match(/^[A-Za-zÁÉÍÓÚáéíóúÑñ]+$/)) {
          showNotification('El usuario debe ser solo el primer nombre, sin espacios ni números.', 'error');
          return;
        }
        if (!documento.match(/^\d{10}$/)) {
          showNotification('El documento debe ser exactamente 10 dígitos.', 'error');
          return;
        }
        if (!pin.match(/^\d{4}$/)) {
          showNotification('El PIN debe ser exactamente 4 dígitos.', 'error');
          return;
        }
        if (!telefono.match(/^\d{10}$/)) {
          showNotification('El teléfono debe ser exactamente 10 números.', 'error');
          return;
        }
        // Verifica si ya existe el usuario con mismo nombre y pin
        const { data: existing, error: errorGet } = await supabase.from('usuarios').select('id').eq('username', username).eq('pin', pin);
        if (errorGet) {
          showNotification('Error de conexión con Supabase: ' + errorGet.message, 'error');
          return;
        }
        if (existing && existing.length > 0) {
          showNotification(`Ups, alguien ya tiene el nombre ${username} y el PIN ${pin}. Intenta registrarlo con el primer apellido.`, 'error');
          return;
        }
        // Verifica si ya existe el usuario solo por nombre
        const { data: existingName } = await supabase.from('usuarios').select('id').eq('username', username);
        if (existingName && existingName.length > 0) {
          showNotification('El usuario ya existe', 'error');
          return;
        }
        // Intenta crear el usuario
        const { error } = await supabase.from('usuarios').insert([{ username, pin, documento, telefono, numero, paused: false, admin: false }]);
        if (error) {
          showNotification('Error al crear usuario: ' + error.message, 'error');
          return;
        }
        showNotification('Añadido con éxito', 'success');
        await renderUsers();
        this.reset();
        document.getElementById('pin').value = '';
      });

      // Edición y acciones de usuario
      window.enableEdit = function(id) {
        document.querySelector(`.edit-username[data-id='${id}']`).disabled = false;
        document.querySelector(`.edit-pin[data-id='${id}']`).disabled = false;
        document.querySelector(`.edit-documento[data-id='${id}']`).disabled = false;
        document.querySelector(`.edit-telefono[data-id='${id}']`).disabled = false;
        document.querySelector(`.edit-numero[data-id='${id}']`).disabled = false;
        const tr = Array.from(document.querySelectorAll('#usersTable tbody tr')).find(tr => tr.querySelector(`.edit-username[data-id='${id}']`));
        tr.querySelector('.save-btn').style.display = '';
        tr.querySelector('.cancel-btn').style.display = '';
        tr.querySelector('button[onclick^="enableEdit"]').style.display = 'none';
        tr.querySelector('button[onclick^="confirmDeleteUserById"]').style.display = 'none';
      }
      window.saveUser = async function(id) {
        const usernameVal = document.querySelector(`.edit-username[data-id='${id}']`).value.trim();
        const pin = document.querySelector(`.edit-pin[data-id='${id}']`).value.trim();
        const documento = document.querySelector(`.edit-documento[data-id='${id}']`).value.trim();
        const telefono = document.querySelector(`.edit-telefono[data-id='${id}']`).value.trim();
        const numero = parseInt(document.querySelector(`.edit-numero[data-id='${id}']`).value, 10);
        if (isNaN(numero) || numero < 0 || numero > 10) return showNotification('El número debe estar entre 0 y 10', 'error');
        if (!documento.match(/^\d{10}$/)) return showNotification('El documento debe ser exactamente 10 dígitos', 'error');
        const { error } = await supabase.from('usuarios').update({ username: usernameVal, pin, documento, telefono, numero }).eq('id', id);
        if (error) {
          showNotification('Error al modificar usuario: ' + error.message, 'error');
        } else {
          showNotification('Modificado con éxito', 'success');
        }
        renderUsers();
      }
      window.confirmDeleteUserById = function(id) {
        // Obtener el usuario para mostrar el nombre
        const userInput = document.querySelector(`.edit-username[data-id='${id}']`);
        const username = userInput ? userInput.value : '';
        if (!borradoEspecialActivado && ['Juan', 'Bc', 'Admin'].includes(username)) {
          alert('No puedes eliminar un usuario por defecto.');
          return;
        }
        if (username === 'Admin') {
          alert('No puedes eliminar el usuario Admin.');
          return;
        }
        if (confirm(`¿Estás seguro de eliminar al usuario "${username}"?`)) {
          window.deleteUserById(id);
        }
      }
      window.deleteUserById = async function(id) {
        const { error } = await supabase.from('usuarios').delete().eq('id', id);
        if (error) {
          showNotification('Error al eliminar usuario: ' + error.message, 'error');
        } else {
          showNotification('Eliminado con éxito', 'success');
        }
        renderUsers();
      }
      window.togglePauseUserById = async function(id) {
        const userInput = document.querySelector(`.edit-username[data-id='${id}']`);
        const username = userInput ? userInput.value : '';
        if (["Juan", "Bc", "Admin"].includes(username)) {
          showNotification('No puedes pausar un usuario por defecto.', 'error');
          return;
        }
        const { data: user } = await supabase.from('usuarios').select('*').eq('id', id).maybeSingle();
        const { error } = await supabase.from('usuarios').update({ paused: !user.paused }).eq('id', id);
        if (error) {
          showNotification('Error al cambiar estado: ' + error.message, 'error');
        } else {
          showNotification(!user.paused ? 'Pausado con éxito' : 'Despausado con éxito', 'success');
        }
        renderUsers();
      }

      // Poder Total (solo para Admin)
      let poderTotalAutorizado = false;
      document.addEventListener('DOMContentLoaded', async function() {
        await renderUsers();
        // Mostrar botón de Poder Total SOLO si el usuario es 'Admin' y es admin
        const poderTotalBtn = document.getElementById('poderTotalBtn');
        const currentUser = localStorage.getItem('currentUser');
        let isAdmin = false;
        if (currentUser === 'Admin') {
          try {
            const { data, error } = await supabase.from('usuarios').select('admin').eq('username', currentUser);
            if (error) {
              alert('Error de conexión con Supabase: ' + error.message);
            } else if (data && data.length > 0 && data[0].admin === true) {
              isAdmin = true;
            }
          } catch (e) {
            alert('Error de conexión con Supabase: ' + e.message);
          }
        }
        poderTotalBtn.style.display = isAdmin ? '' : 'none';
        // Mostrar panel solo si Admin pulsa el botón y pasa la clave
        poderTotalBtn.onclick = async function() {
          if (!poderTotalAutorizado) {
            const clave = prompt('Digite la clave para acceder al poder total:');
            if (clave !== 'Pepitapigi1.') {
              alert('Clave incorrecta.');
              return;
            }
            poderTotalAutorizado = true;
          }
          mostrarPanelPoderTotal();
        };
      });
      async function mostrarPanelPoderTotal() {
        let panel = document.getElementById('poderTotalPanel');
        if (!panel) {
          panel = document.createElement('div');
          panel.id = 'poderTotalPanel';
          panel.style = 'background:#fff; color:#222; border:2px solid #e67e22; border-radius:8px; padding:18px; margin-bottom:18px; max-width:400px;';
          document.querySelector('.container').insertBefore(panel, document.querySelector('h1'));
        }
        // Obtener usuario Bc desde Supabase
        const user = await getUserSupabase('Bc');
        if (!user) {
          panel.innerHTML = '<b>No existe el usuario Bc.</b>';
          return;
        }
        const isPaused = user.paused;
        const icon = isPaused ? '▶️' : '⏸️';
        const iconTitle = isPaused ? 'Reactivar admin Bc' : 'Pausar admin Bc';
        panel.innerHTML = `
          <div style='display:flex; align-items:center; gap:12px; margin-bottom:12px;'>
            <b>Usuario:</b> <span style='color:#0077b6;'>Bc</span>
            <b>PIN:</b> <span style='color:#e67e22;'>${user.pin}</span>
            <button onclick="togglePauseBc()" title="${iconTitle}" style="background:none;border:none;font-size:1.5em;cursor:pointer;">${icon}</button>
          </div>
          <button id="pausarTodosBtn" style="margin-top:10px; background:#e74c3c; color:#fff; border:none; border-radius:6px; padding:10px 18px; font-weight:bold; cursor:pointer;">Pausar a todos los usuarios</button>
          <button id="despausarTodosBtn" style="margin-top:10px; background:#27ae60; color:#fff; border:none; border-radius:6px; padding:10px 18px; font-weight:bold; cursor:pointer; margin-left:10px;">Despausar a Todos</button>
          <div style='margin-top:18px; padding:10px; border-top:1px solid #eee; display:flex; align-items:center; gap:12px;'>
            <div style='background:#f4f4f4; border-radius:6px; padding:7px 14px; font-weight:bold; border:1.5px solid #e67e22;'>Borrado Especial</div>
            <button id="borradoEspecialSwitch" style="background:none; border:none; font-size:1.1em; cursor:pointer; font-weight:bold; color:${borradoEspecialActivado ? '#27ae60' : '#c0392b'};">${borradoEspecialActivado ? '✅ Activado' : '❌ Desactivado'}</button>
          </div>
          <div id="borradoEspecialMsg" style="margin-top:6px; color:#c0392b; font-size:0.98em;"></div>
        `;
        document.getElementById('pausarTodosBtn').onclick = pausarTodosMenosAdminYJuan;
        document.getElementById('despausarTodosBtn').onclick = despausarTodosMenosAdminYJuan;
        document.getElementById('borradoEspecialSwitch').onclick = function() {
          borradoEspecialActivado = !borradoEspecialActivado;
          mostrarPanelPoderTotal();
        };
      }
      async function pausarTodosMenosAdminYJuan() {
        // Pausa todos los usuarios excepto Admin y Juan
        const { data, error } = await supabase.from('usuarios').select('username, paused');
        if (error) {
          showNotification('Error al obtener usuarios: ' + error.message, 'error');
          return;
        }
        const usuariosAPausar = data.filter(u => u.username !== 'Admin' && u.username !== 'Juan' && !u.paused);
        if (usuariosAPausar.length === 0) {
          showNotification('No hay usuarios activos para pausar.', 'success');
          return;
        }
        const usernames = usuariosAPausar.map(u => u.username);
        const { error: errorUpdate } = await supabase.from('usuarios').update({ paused: true }).in('username', usernames);
        if (errorUpdate) {
          showNotification('Error al pausar usuarios: ' + errorUpdate.message, 'error');
        } else {
          showNotification('Todos los usuarios (excepto Admin y Juan) han sido pausados.', 'success');
        }
        renderUsers();
        mostrarPanelPoderTotal();
      }
      async function despausarTodosMenosAdminYJuan() {
        if (!confirm('Al aplicar esta función, todos (incluidos los que estaban bloqueados antes de la pausa masiva) serán despausados, ¿desea continuar?')) return;
        const { data, error } = await supabase.from('usuarios').select('username, paused');
        if (error) {
          showNotification('Error al obtener usuarios: ' + error.message, 'error');
          return;
        }
        const usuariosADespausar = data.filter(u => u.username !== 'Admin' && u.username !== 'Juan' && u.paused);
        if (usuariosADespausar.length === 0) {
          showNotification('No hay usuarios pausados para despausar.', 'success');
          return;
        }
        const usernames = usuariosADespausar.map(u => u.username);
        const { error: errorUpdate } = await supabase.from('usuarios').update({ paused: false }).in('username', usernames);
        if (errorUpdate) {
          showNotification('Error al despausar usuarios: ' + errorUpdate.message, 'error');
        } else {
          showNotification('Todos los usuarios (excepto Admin y Juan) han sido despausados.', 'success');
        }
        renderUsers();
        mostrarPanelPoderTotal();
      }
      window.togglePauseBc = async function() {
        const user = await getUserSupabase('Bc');
        const { error } = await updateUserSupabase('Bc', { paused: !user.paused });
        if (error) {
          showNotification('Error al cambiar estado: ' + error.message, 'error');
        } else {
          showNotification(!user.paused ? 'Pausado con éxito' : 'Despausado con éxito', 'success');
        }
        mostrarPanelPoderTotal();
      }
      // BARRA DE BÚSQUEDA DE USUARIOS
      // Evento para filtrar usuarios en tiempo real
      if (document.getElementById('busquedaUsuarios')) {
        document.getElementById('busquedaUsuarios').addEventListener('input', renderUsers);
      }
      function goToLogin() {
        if (confirm('¿Estás seguro de querer ir al login?')) {
          // Cierra sesión limpiando localStorage
          localStorage.removeItem('bahiaChillLogin');
          localStorage.removeItem('currentUser');
          window.location.href = 'index.html';
        }
      }
      // Autocompletar PIN al terminar documento
      document.getElementById('documento').addEventListener('input', function() {
        const doc = this.value.trim();
        const pinInput = document.getElementById('pin');
        if (doc.length === 10) {
          pinInput.value = doc.slice(-4);
        } else {
          pinInput.value = '';
        }
      });
    </script>
</body>
</html>
